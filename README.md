# Test_app

## Table of Contents

- [Requirements](##requirements)
- [Initialization](##initialization)
- [Setup](##setup)
- [Deployment](##deployment)
- [Api Document](##api-documents)
- [Authentication](##authentication)
- [Sending Email](##sending-email)
- [Supplement](##supplement)

## Requirements

- Docker 19.x
  If you run the project locally, the followings are required.
- Node 16.x
- Yarn 1.22.x
- Postgres 8.0.x

## Setup

Setup procedure of development environment.
Run `cp env.example .env` and open `.env` file to edit environment variables.

### Docker environment

Build docker containers

```bash
docker-compose build
```

Setup database Development

```bash
docker-compose run api yarn db:init
```

Start the app

```bash
docker-compose up
```

### Local environment

Install dependencies

```bash
yarn install
```

Start postgres and redis services

```bash
docker-compose up -d db redis
```

Update database and redis host in .env file

```bash
DATABASE_HOST=localhost
REDIS_HOST=localhost
```

Setup database

```bash
yarn db:init
```

Start the app

```bash
yarn start
```

## Deployment

Once you created the staging and production environments in Jitera's DevOps menu, you can deploy to staging by pushing a new commit to `develop` branch, and to production by pushing a new commit to `master` branch.

## API Documents

Use the link below to access api document:

```url
http://localhost:3000/api-docs
```

Input the credentials:

```
Username: swagger
Password: swagger
```

You can adjust swagger url and credentials by edit these configs in .env file

```
SWAGGER_PATH=api-docs
SWAGGER_USERNAME=swagger
SWAGGER_PASSWORD=swagger
```

## Authentication

#### Confirmation:

Sends email with confirmation instructions and verifies whether an account is already confirmed during sign in. Following these steps to enable confirmation feature:

- Add these configs into .env file

```
AUTH_SEND_CONFIRMATION_EMAIL=true
AUTH_CONFIRMATION_URL=[confirmation link attach in email]
```

- Follow [Sending Email](###sending-email) section to setup mail service

#### Reset Password

Change password by using registration email. After requesting reset password, an email will be sent with a token attached in a link. Using this token for change new password. Following these steps to enable reset password feature:

- Add these configs into .env file

```
AUTH_RESET_PASSWORD_URL=[reset password link attach in email]
AUTH_RESET_PASSWORD_IN=[hour] // default is 1 hour
```

- Follow [Sending Email](###sending-email) section to setup mail service

## Sending Email

Currently, we're only supporting 2 email providers: SES and SendGrid

- Use these configs in .env file in order to config email setting

```
MAIL_PROVIDER=[email provider] // select one of 'ses' or 'sendgrid'. Default is 'ses'
MAIL_FROM=[email sender]
SES_USERNAME=[SES Username]
SES_PASSWORD=[SES Password]
SENDGRID_API_KEY=[SendGrid Api Key]
```

- How to use email service:

Import `EmailService` in `MailModule` into your service

```typescript
import { MailService } from 'src/shared/mail/mail.service';

@Injectable()
export class YouService {
  constructor(private readonly mailService: MailService) {}
}
```

Call `sendMail` action inside you service action with these options

```typescript
await this.mailService.sendMail({
  to: 'email-receiver',
  subject: 'email-subject',
  template: 'template-name-without-extension',
  context: {
    // The payload using for template
    data: 'data',
  },
});
```

Compose a email template file with exact file name you using above in folder:

```
shared/mail/templates/[template-name].hbs
```

Handlebars syntax:

```
https://handlebarsjs.com/
```

## Supplement

This project was generated by jitera automation, run by Jitera.
